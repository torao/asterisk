<<<<<<< HEAD
# Basic Structure

asterisque ではノードが通信を行う時に双方のノードでセッションが発生します。通信は双方のノードがセッション上でメッセージと呼ばれるデータ単位を交換することによって行われます。

## Communication Layer

### Service

### Session, Pipe
* 通信状態を管理しメッセージの順序を意識する。

### Wire, Server
* 下層のプロトコル実装を抽象化したレイヤー。
* ピアとの双方向メッセージ通信を行うが、メッセージの順序や状態管理は行わない。

### WebSocket, Netty
* Netty の WebSocketFrame レベルでの情報伝達。

## Message

**Message** は数バイトから数十キロバイトのバイナリで表現される asterisque 通信の基本的なデータ単位。1つのメッセージサイズは小規模なデバイスでも一度にメモリ上に乗せられるデータ量を想定し 65,535 バイトまでとしている。

asterisque で使用するメッセージは `Open`, `Close`, `Block`, `Control` の 4 種類である。以下にそれぞれのメッセージについて記述する。

### Open メッセージ

| field name | type    | size  | description |
|------------|---------|-------|-------------|
| pipeId     | UINT16  |     2 | |
| functionId | UINT16  |     2 | |
| params     | OBJECT* |     * | |
| priority   | INT8    |     1 | default 0 |

Open メッセージはリモートノードに実装されている function (処理) を起動しセッション上にパイプを構築するために使用される。メッセージには function に特有のパラメータを含めることができる。

Open メッセージが受け入れられ function の処理が開始するとパイプが発生して通信端点の双方にキューが生成される。その呼び出しに関連するメッセージは全てそのキューに宛てられる。

同一のセッション内で複数のパイプが発生する。優先度を指定することでパイプ間でやりとりされるメッセージを調整することができる。

セッション上でピアに公開しているサービスの function は状況によって変化するため、functionId が利用可能かは動的に変化する。

### Close メッセージ

| field name | type   | size | description |
|------------|--------|------|-------------|
| pipeId     | UINT16 |    2 | |
| result     | OBJECT |    * | |
| abort      | ABORT  |    * | {code, message} |

Close メッセージはパイプを終了し通信相手にパイプ上で行われた処理の結果を返すために使用される。メッセージは成功した処理の結果か、失敗したエラー情報のどちらかを含むことができる。

Close メッセージの送受信によりセッション上のパイプは消滅する。

### Block メッセージ

| field name | type   | size | description |
|------------|--------|------|-------------|
| pipeId     | UINT16 |    2 | |
| bit fields | UINT8  |    1 | |
| payload    | UINT8* |    * | |

Block メッセージはセッション上に構築したパイプ上でのメッセージングや Blob 転送に使用される。

bit fields は以下のように定義される。

| field name | bit size | description |
|------------|----------|-------------|
| eof        |        1 | default 0   |
| loss       |        7 | default 0   |

eof が 1 の場合、そのブロックがストリームの終端を表し、そうでないブロックは続くブロックが存在していることを表している。

loss はこのブロックメッセージが欠落してもよい可能性を 0-127 の範囲で定義している。loss が 0 のブロックメッセージに対する中継処理による欠落は明確に禁止されている。しかし、それ以外の loss を持つブロックは意図的に欠落する可能性がある。

eof ビットが立っていても loss を 0 以外の値に設定することができる。このとき loss を認識してブロックの欠落を行う中継処理は eof ビットを前方の非欠落ブロックメッセージに移動させなければならない。

### Control

| field name | type   | description |
|------------|--------|-------------|
| code       | INT32  | |
| data       | UINT8* | |

Control メッセージはセッション開始時の状態同期やセッション終了などの制御に用いられる。

### 相互動作

単純な RPC を行うケースでは、リモート処理の起動、及び結果の取得は Open メッセージと Close メッセージの 1 往復で行われます (これは後述するパイプの生成と消滅と等価です)。往路の Open メッセージには実行するリモート処理のファンクション番号と実行パラメータ、優先度が付属します。また復路の Close メッセージは正常終了または異常終了の結果が付属します。これは一般的な RPC 実装での Request-Response 型メッセージングと同じモデルです。

Block メッセージは RPC 実行時の Open から Close までの間に呼び出し元と飛び出し先の処理でメッセージ交換を行うために使用されます。この Block メッセージを使用してローカル/リモート処理の間で非同期メッセージング、ストリーミングまたは BLOB 転送を行う事が出来ます。ローカル/リモート処理は 1 度の呼び出し中に任意個数の Block メッセージを送受信することができます。

Control メッセージは接続時の状態の同期や接続終了などセッション制御に関するインタラクションを行うためのメッセージです。

## State Management

asterisque は **Node** と呼ばれる抽象化されたネットワーク上の通信端点を定義するところから始まります。

ノードがリモートと接続すると双方向に **Session** が発生します。Session にはリモート呼び出しが可能な **Function** のセット及びアプリケーション状態を持つ **Service** が関連付けられています。

リモートの Function を呼び出す時、双方の Session にその処理の開始から終了まで **Pipe** が発生します。Pipe は Block 及び Close メッセージの宛先を示し、またそのためのキューを持ちます。単純な RPC 呼び出しのケースでは Pipe も短命で消滅するが、1 度の呼び出し内で継続的にメッセージパッシングなどを行うケースでは長い寿命を持つでしょう。

asterisque でのリモート処理は双方のセッションで Pipe を Open し、Pipe を通じて Block を交換し、Pipe を Close するというモデルです。

## Communication Implementation

=======
# Basic Structure

asterisque ではノードが通信を行う時に双方のノードでセッションが発生します。通信は双方のノードがセッション上でメッセージと呼ばれるデータ単位を交換することによって行われます。

## Message

**Message** は数バイトから数十キロバイトのバイナリで表現される asterisque 通信の基本的なデータ単位。1つのメッセージサイズは小規模なデバイスでも一度にメモリ上に乗せられるデータ量を想定し 65,535 バイトまでとしている。

asterisque で使用するメッセージは `Open`, `Close`, `Block`, `Control` の 4 種類である。以下にそれぞれのメッセージについて記述する。

### Open メッセージ

| field name | type    | size  | description |
|------------|---------|-------|-------------|
| pipeId     | UINT16  |     2 | |
| functionId | UINT16  |     2 | |
| params     | OBJECT* |     * | |
| priority   | INT8    |     1 | default 0 |

Open メッセージはリモートノードに実装されている function (処理) を起動しセッション上にパイプを構築するために使用される。メッセージには function に特有のパラメータを含めることができる。

Open メッセージが受け入れられ function の処理が開始するとパイプが発生して通信端点の双方にキューが生成される。その呼び出しに関連するメッセージは全てそのキューに宛てられる。

同一のセッション内で複数のパイプが発生する。優先度を指定することでパイプ間でやりとりされるメッセージを調整することができる。

セッション上でピアに公開しているサービスの function は状況によって変化するため、functionId が利用可能かは動的に変化する。

### Close メッセージ

| field name | type   | size | description |
|------------|--------|------|-------------|
| pipeId     | UINT16 |    2 | |
| result     | OBJECT |    * | |
| abort      | ABORT  |    * | {code, message} |

Close メッセージはパイプを終了し通信相手にパイプ上で行われた処理の結果を返すために使用される。メッセージは成功した処理の結果か、失敗したエラー情報のどちらかを含むことができる。

Close メッセージの送受信によりセッション上のパイプは消滅する。

### Block メッセージ

| field name | type   | size | description |
|------------|--------|------|-------------|
| pipeId     | UINT16 |    2 | |
| bit fields | UINT8  |    1 | |
| payload    | UINT8* |    * | |

Block メッセージはセッション上に構築したパイプ上でのメッセージングや Blob 転送に使用される。

bit fields は以下のように定義される。

| field name | bit size | description |
|------------|----------|-------------|
| eof        |        1 | default 0   |
| loss       |        7 | default 0   |

eof が 1 の場合、そのブロックがストリームの終端を表し、そうでないブロックは続くブロックが存在していることを表している。

loss はこのブロックメッセージが欠落してもよい可能性を 0-127 の範囲で定義している。loss が 0 のブロックメッセージに対する中継処理による欠落は明確に禁止されている。しかし、それ以外の loss を持つブロックは意図的に欠落する可能性がある。

eof ビットが立っていても loss を 0 以外の値に設定することができる。このとき loss を認識してブロックの欠落を行う中継処理は eof ビットを前方の非欠落ブロックメッセージに移動させなければならない。

### Control

| field name | type   | description |
|------------|--------|-------------|
| code       | INT32  | |
| data       | UINT8* | |

Control メッセージはセッション開始時の状態同期やセッション終了などの制御に用いられる。

### 相互動作

単純な RPC を行うケースでは、リモート処理の起動、及び結果の取得は Open メッセージと Close メッセージの 1 往復で行われます (これは後述するパイプの生成と消滅と等価です)。往路の Open メッセージには実行するリモート処理のファンクション番号と実行パラメータ、優先度が付属します。また復路の Close メッセージは正常終了または異常終了の結果が付属します。これは一般的な RPC 実装での Request-Response 型メッセージングと同じモデルです。

Block メッセージは RPC 実行時の Open から Close までの間に呼び出し元と飛び出し先の処理でメッセージ交換を行うために使用されます。この Block メッセージを使用してローカル/リモート処理の間で非同期メッセージング、ストリーミングまたは BLOB 転送を行う事が出来ます。ローカル/リモート処理は 1 度の呼び出し中に任意個数の Block メッセージを送受信することができます。

Control メッセージは接続時の状態の同期や接続終了などセッション制御に関するインタラクションを行うためのメッセージです。

## State Management

asterisque は **Node** と呼ばれる抽象化されたネットワーク上の通信端点を定義するところから始まります。

ノードがリモートと接続すると双方向に **Session** が発生します。Session にはリモート呼び出しが可能な **Function** のセット及びアプリケーション状態を持つ **Service** が関連付けられています。

リモートの Function を呼び出す時、双方の Session にその処理の開始から終了まで **Pipe** が発生します。Pipe は Block 及び Close メッセージの宛先を示し、またそのためのキューを持ちます。単純な RPC 呼び出しのケースでは Pipe も短命で消滅するが、1 度の呼び出し内で継続的にメッセージパッシングなどを行うケースでは長い寿命を持つでしょう。

asterisque でのリモート処理は双方のセッションで Pipe を Open し、Pipe を通じて Block を交換し、Pipe を Close するというモデルです。

## Communication Implementation

>>>>>>> 3fd290ac667eea8e95a7efe40edf8573b773242c
