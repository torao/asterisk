## ネットワーク認証局

asterisque の P2P ネットワークは CA (証明書認証局) が承認したノードによって構成されます。これらのノード (以後ネットワーク参加者と呼びます) は、自分が通信を行おうとしている相手が、自分が利用している P2P ネットワークの正当な参加者であることを相手の証明書を検証することで確認することができます。

ネットワーク参加者はローカルにデプロイされている信頼済み CA 証明書と、CA 機関から自分に発行された証明書を使用して P2P ネットワークに参加します。ネットワークに接続した後、ネットワークに流通している中間証明書や CRL (証明書失効リスト) を同期してローカルにキャッシュします。

asterisque の P2P ネットワークは証明書を持っていれば参加することができます。つまり参加がオープンであるかクローズドであるかはネットワークの CA の証明書発行ポリシーに依存します。

```
conf/
+-- authority/
    +-- private/
        +-- private.p12           # Private Key and Certificate (PKCS#12)
    +-- trusted/
        +-- my_private_ca1.p7b    # Private CA Certificate Chain (PKCS#7 or PEM)
        +-- my_private_ca2.p7b
        +-- ...
    +-- blocked/
        +-- blocked_cert1.pem
        +-- blocked_cert2.pem
        +-- ...
```

### 信頼済み CA 証明書

asterisque は以下の CA を信頼済み CA とみなします。

1. 自分の証明書を発行した CA
2. `trusted/` ディレクトリに保存されている CA 証明書の CA
3. P2P ネットワーク上でブロードキャストされた、信頼済み CA によって署名された CA 証明書

CA 証明書には PKCS#7 形式、または複数の CA 証明書が含まれている PEM 形式の証明書パスを使用することができます。

これらの信頼済み CA のいずれか、もしくは、それらの一つから認証された中間 CA により発行されてたノード証明書を検証することで自分と同じ P2P ネットワークの参加者として認識することができます。別のノードとの接続や処理要求の受け入れは相手のノードの証明書がネットワーク参加者であるかを検証します。

複数の信頼済み CA 証明書を持つことで P2P ネットワークをよりロバストに保つことができます。これは一つの CA にネットワークの権限や負荷が集中せず、また CA 証明書の入れ替えも容易に行う効果があります。どの CA 証明書を信頼済みとしてノードにデプロイするかはノードの管理者に任せられています。

1 つのノードが異なる P2P ネットワークの CA 証明書を信頼することで双方のネットワークと接続することができます。ただし、そのような構成は十分に考慮されておらず、認証されていない処理のブロードキャストによってネットワークに無駄な負荷を増加させるため良い方法ではないかもしれません。セキュリティに関しても未知です。今のところ異なる P2P ネットワークには異なるノードで接続する (そして必要であればノード間を Message Queue などで接続する) ことを前提としています。

信頼済み CA の証明書は証明書パスのルート (自己署名証明書) である必要はありません。信頼済み CA の証明書を発行した CA が暗黙的に信頼済み CA になることはありません。

### 中間証明書

P2P ネットワークでは役割 (responsibility) 付きの証明書チェーンが共有されます。具体的には、証明書チェーンのルートにローカルインストールされている信頼済み CA 証明書を含み、CN (Common Name) に Multi-Valued RDN の書式で役割が記述されている証明書です。例えば以下の CN を持つ証明書は ca と committer の役割を持ちます。

```
node001.carillon.asterisque.io+roles=ca,committer
```
Distinguished Name エンコードされた RFC 2253 書式では以下のように

```
CN=node001.carillon.asterisque.io+roles=ca\,committer
```

Carillon では `ca` の役割を持つ証明書を中間 CA 証明書と認識します。それ以外の責務は Carillon 上で動作するアプリケーションに特権的な命令を許可したい場合などに利用することができます。

中間 CA 証明書は信頼済み CA 証明書と同様にネットワーク参加者の証明書を検証することができます。

新しいノードが P2P ネットワークに接続すると近隣のノードと役割付き証明書を同期します。また新しい役割付き証明書を発見するとすみやかに近隣のノードに通知します。ノードはネットワークから収集した有効な役割付き証明書をローカルのキャッシュします。

役割付き証明書は PEM 形式の PKCS#7 で共有することができます。

### 証明書失効リスト

CRL (証明書失効リスト) は有効期限前の証明書を無効化するために P2P ネットワークで共有されます。

1. 自分自身の証明書を無効化する。これは秘密鍵の漏れた証明書を自身で (あるいは入手した第三者が) すみやかに凍結することを目的としています。
2. CA が自分の発行した証明書を無効化する。これは虚偽報告や攻撃などにより不当に発行した証明書を凍結することを目的としています。
3. CA が任意の証明書を無効化する。
3. 信頼済み CA のみが任意の証明書を無効化できる。

これらの全てが許可されるわけではなく、CRL の扱いは P2P ネットワークのポリシーによって決まります。

## Specification

### Trust Manager

* `private.p12` にはエントリごとにローカルノードの秘密鍵と証明書、証明書を発行した CA 証明書パスが保存されいる。この CA 証明書パスは暗黙的に信頼済み CA と認識される。
* `trusted/` 以下のファイルには asterisque が信頼済み CA とみなす CA の証明書パスが保存されている。これは PEM 形式であり、PKCS#7 形式、または、証明書パス上の全ての証明書が含まれる。
* `blocked/` 以下のファイルには asterisque がブロックすべき証明書、CA 証明書、CRL が保存されている。PKCS#7 は証明書パスをブロック対象と認識し CRL は無視される。

