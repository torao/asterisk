# Alive Monitoring and Recovering

(未実装)

## <a name="Monitoring"></a>Monitoring

TCP を使用した asterisque の Wire 実装は Wire 上で交換されるメッセージの途切れを監視し一定時間受信または送信が行われなかった場合に自動的に切断と再接続を行います。

アプリケーションが長時間メッセージの交換を行わない場合でも接続を維持するために、切断監視より短い一定時間内に受信または送信が行われなかった場合にサーバから ping 制御メッセージが送信されます。クライアントはこの ping に応答することで切断時間内にメッセージの交換が発生し切断監視を回避することを保証します。

ping 時間 $t_p$ と切断監視時間 $t'$ は Wire の接続が完了した時の SyncConfig メッセージでネゴシエーションされます。

### ping の動作

ネットワーク上のメッセージ送受信を減らすため ping は定期的に実行しません。サーバは最後のメッセージ送信からの経過時間 $t_s$ または受信からの経過時間 $t_r$ の長い方 $t = max(t_s, t_r)$ が ping 間隔 $t_p$ に達した場合に ping を実行します。

サーバは Wire 接続が開始した時点を $t = 0$ とし $t_p$ 後にメッセージの送信または受信が行われていなければ ping 制御メッセージを送信します。$t < t_p$ であれば (送受信が行われていれば) 何もせず次回の $t_p - t$ 後に再び ping 実行判定を行います。

クライアントは ping 制御メッセージを受信したらそれに応答する ping 制御メッセージを送信します。


### メッセージ到達監視

切断監視までの時間を $t'$ とした場合、クライアント - サーバ共に $t > t'$ となった場合にネットワーク異常と判断し切断及び再接続手順に入ります。


## <a name="Reconnect"><a>Reconnect

ルーターなどの介在により TCP 接続の開始には方向性があります。再接続を行うことができるのはクライアント側であるケースが多いことからクライアント側から再接続を行います。

asterisque のセッション中に切断を検知した場合、サーバはクライアントからの再接続に備えてセッションをリポジトリに待避させます。サーバは再接続を受け付けたときリポジトリからセッションを復元してセッションを再開します。

リポジトリを共有化することでサーバのクラスタリングが可能になります。

再接続を受け付けたサーバは相手のノード証明書と相手の要求したセッション ID に基づいてセッションを復元します。該当するセッションがリポジトリに存在しない場合 RetryAfter で応答し切断します。


## <a name="SessionRecovering"></a> Session Recovering
